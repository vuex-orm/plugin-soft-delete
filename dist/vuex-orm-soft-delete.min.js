!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).VuexORMSoftDelete=t()}(this,function(){"use strict";var t=function(){return(t=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function a(e,s,l,a){return new(l=l||Promise)(function(r,t){function n(e){try{i(a.next(e))}catch(e){t(e)}}function o(e){try{i(a.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?r(e.value):((t=e.value)instanceof l?t:new l(function(e){e(t)})).then(n,o)}i((a=a.apply(e,s||[])).next())})}function u(r,n){var o,i,s,e,l={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;l;)try{if(o=1,i&&(s=2&t[0]?i.return:t[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,t[1])).done)return s;switch(i=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return l.label++,{value:t[1],done:!1};case 5:l.label++,i=t[1],t=[0];continue;case 7:t=l.ops.pop(),l.trys.pop();continue;default:if(!(s=0<(s=l.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){l=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){l.label=t[1];break}if(6===t[0]&&l.label<s[1]){l.label=s[1],s=t;break}if(s&&l.label<s[2]){l.label=s[2],l.ops.push(t);break}s[2]&&l.ops.pop(),l.trys.pop();continue}t=n.call(r,l)}catch(e){t=[6,e],i=0}finally{o=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}}function e(l,e){e.softDelete=function(e){return this.dispatch("softDelete",e)},e.prototype.$softDelete=function(i){return a(this,void 0,void 0,function(){var t,r,n,o;return u(this,function(e){switch(e.label){case 0:return[4,this.$dispatch("softDelete",this.$self().getIdFromRecord(this))];case 1:return(t=e.sent(),i)?(this.$fill(t.$getAttributes()),[2,this]):(r=l.createConfig(this.$self().softDeleteConfig),n=r.key,o=r.flagName,this[n]=t[n],this[o]=t[o],[2,t])}})})},e.prototype.$restore=function(s){return a(this,void 0,void 0,function(){var t,r,n,o,i;return u(this,function(e){switch(e.label){case 0:return t=l.createConfig(this.$self().softDeleteConfig),r=t.key,n=t.flagName,[4,this.$dispatch("update",{where:this.$self().getIdFromRecord(this),data:((i={})[r]=null,i[n]=!1,i)})];case 1:return(o=e.sent(),s)?(this.$fill(o.$getAttributes()),[2,this]):(this[r]=o[r],this[n]=o[n],[2,this])}})})},e.prototype.$trashed=function(){var e=l.createConfig(this.$self().softDeleteConfig).flagName;return!0===this[e]},e.prototype.softDelete=function(e){return"production"!==process.env.NODE_ENV&&console.warn("The `softDelete` instance method has been deprecated. Please use `$softDelete`."),this.$softDelete(e)};var i=e.prototype.$fields;e.prototype.$fields=function(){var e,t=i.call(this),r=l.createConfig(this.$self().softDeleteConfig),n=r.key,o=r.flagName;return Object.assign({},t,((e={})[n]=this.$self().attr(null),e[o]=this.$self().attr(!1),e))};var o=e.prototype.$toJson;e.prototype.$toJson=function(){var e=o.call(this),t=l.createConfig(this.$self().softDeleteConfig);if(!0===t.exposeFlagsExternally)return e;var r=t.key,n=(e[r],t.flagName);e[n];return function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]])}return r}(e,["symbol"==typeof r?r:r+"","symbol"==typeof n?n:n+""])}}var r={key:"deleted_at",flagName:"$isDeleted",exposeFlagsExternally:!0,mutator:null},n=(o.prototype.createConfig=function(e){return t(t(t({},r),this.config),e)},o.prototype.plugin=function(){var o,r;e(this,this.model),function(u,e){e.prototype.softDeleteSelectFilter=null,e.prototype.withTrashed=function(){return this.softDeleteSelectFilter=!1,this},e.prototype.onlyTrashed=function(){return this.softDeleteSelectFilter=!0,this},e.prototype.trashed=function(){return"production"!==process.env.NODE_ENV&&console.warn("The `trashed` method has been deprecated. Please use `onlyTrashed`."),this.onlyTrashed()},e.prototype.softDelete=function(t){var e,r=u.createConfig(this.model.softDeleteConfig),n=r.key,o=r.flagName,i=r.mutator,s=Date.now();s="function"==typeof i?i(s):s;var l=((e={})[n]=s,e[o]=!0,e);if(Array.isArray(t)){if(!this.model.isCompositePrimaryKey())return this.model.update({data:l,where:function(e){return t.includes(e[e.$primaryKey()])}});if(t.some(function(e){return Array.isArray(e)})){var a=t.map(function(e){return Array.isArray(e)&&JSON.stringify(e)}).filter(Boolean);return this.model.update({data:l,where:function(e){return a.includes(e.$id)}})}}return this.model.update({data:l,where:t})},e.prototype.allTrashed=function(){return this.newQuery().onlyTrashed().get()};var r=e.prototype.newQuery;e.prototype.newQuery=function(e){var t=r.call(this,e),n=Object.keys(this.load);return 0<n.length&&(t.softDeleteSelectFilter=this.softDeleteSelectFilter,e&&e!==this.entity&&this.model.hasPivotFields()&&this.model.pivotFields().reduce(function(t,r){return Object.keys(r).filter(function(e){return n.includes(e)}).forEach(function(e){t.push(r[e].pivot.entity)}),t},[]).includes(e)&&(t.softDeleteSelectFilter=!1)),t},e.allTrashed=function(r){var n=this,e=r.$db().models();return Object.keys(e).reduce(function(e,t){return e[t]=new n(r,t).onlyTrashed().get(),e},{})},e.on("beforeSelect",function(t){var r=this;return t.filter(function(e){return!0===r.softDeleteSelectFilter?e.$trashed():!1===r.softDeleteSelectFilter?t:!e.$trashed()})})}(this,this.query),function(e){var t=this;e.softDelete=function(i,s){return a(t,void 0,void 0,function(){var t,r,n,o;return u(this,function(e){return t=i.state,r=t.$name,n=null!==(o=s.where)&&void 0!==o?o:s,[2,i.dispatch(t.$connection+"/softDelete",{entity:r,where:n},{root:!0})]})})}}(this.actions),this.getters.allTrashed=function(e,t,r,n){return function(){return n[e.$connection+"/allTrashed"](e.$name)}},(o=this).rootActions.softDelete=function(e,n){return a(this,void 0,void 0,function(){var t,r;return u(this,function(e){return t=n.entity,r=n.where,[2,new o.query(this,t).softDelete(r)]})})},(r=this).rootGetters.allTrashed=function(e){var t=this;return function(e){return e?new r.query(t,e).allTrashed():r.query.allTrashed(t)}}},o);function o(e,t){this.model=e.Model,this.query=e.Query,this.actions=e.Actions,this.getters=e.Getters,this.rootActions=e.RootActions,this.rootGetters=e.RootGetters,this.config=this.createConfig(t)}return{install:function(e,t){new n(e,t).plugin()}}});